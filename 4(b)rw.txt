#Reader-Writer problem

#include<stdio.h>
#include<unistd.h>
#include<stdlib.h>
#include<pthread.h>
#include<semaphore.h>
//sem_t rw_mutex,mutex ;
pthread_mutex_t rw_mutex,mutex;
pthread_t rd[10],wt[10];
int counter=0,data=0;
//--------------------------------------------------------------
void initsem()     // initialisen semaphore 
{
//sem_init(&rw_mutex,1,1);
pthread_mutex_init(&mutex,NULL);
//sem_init(&mutex,1,1);
pthread_mutex_init(&rw_mutex,NULL);
}
//--------------------------------------------------------------

void * reader(void * r)
{
long int rno;
rno=(long int)r;
//sem_wait(&mutex);
pthread_mutex_lock(&mutex);
counter++;
if(counter==1)
{
//sem_wait(&rw_mutex);
pthread_mutex_lock(&rw_mutex);
printf("\n This is the first reader locks writer and lets in all reader for reading");
}
//sem_post(&mutex);
pthread_mutex_unlock(&mutex);
sleep(1);
printf("\n reader R[%ld] has read  data=%d",rno,data);
//sem_wait(&mutex);
pthread_mutex_lock(&mutex);
counter--;
if(counter==0)
{
//this is last reader
//sem_post(&rw_mutex);
pthread_mutex_unlock(&rw_mutex);
printf("\nThis is the last reader lets ulock waiting writer to write on data");
}
else
//sem_post(&mutex);
pthread_mutex_unlock(&mutex);
pthread_exit(NULL);
}

//--------------------------------------------------------------
void * writer(void * w)
{
long int wno;
wno=(long int)w;
//sem_wait(&rw_mutex);
pthread_mutex_lock(&rw_mutex);
data=rand()%10;
printf("\n Writer W[%ld] has update data=%d",wno,data);
//sem_post(&rw_mutex);
pthread_mutex_unlock(&rw_mutex);
pthread_exit(NULL);
}
//--------------------------------------------------------------
void main()
{
int n1,n2;
long int i;
initsem();
printf("\n Enter the number of readers");
scanf("%d",&n1);
printf("\n Enter the number of writers");
scanf("%d",&n2);
for(i=0;i<n1;i++)
{
pthread_create(&rd[i],NULL,reader,(void *)i);
}
for(i=0;i<n1;i++)
{
pthread_join(rd[i],NULL);
}
for(i=0;i<n2;i++)
{
pthread_create(&wt[i],NULL,writer,(void *)i);
}
for(i=0;i<n2;i++)
{
pthread_join(wt[i],NULL);
}
printf("\n");
}


#OUTPUT
svpmit31@svpmit31-HP-EliteDesk-800-G2-SFF:~/Documents$ gcc readwrire.c -o rw -pthread
svpmit31@svpmit31-HP-EliteDesk-800-G2-SFF:~/Documents$ ./rw

 Enter the number of readers 10

 Enter the number of writers 10

 This is the first reader locks writer and lets in all reader for reading
 reader R[1] has read  data=0
 reader R[2] has read  data=0
 reader R[3] has read  data=0
 reader R[0] has read  data=0
 reader R[4] has read  data=0
 reader R[7] has read  data=0
 reader R[5] has read  data=0
 reader R[6] has read  data=0
 reader R[8] has read  data=0
 reader R[9] has read  data=0
This is the last reader lets ulock waiting writer to write on data
 Writer W[0] has update data=3
 Writer W[1] has update data=6
 Writer W[2] has update data=7
 Writer W[3] has update data=5
 Writer W[4] has update data=3
 Writer W[5] has update data=5
 Writer W[6] has update data=6
 Writer W[7] has update data=2
 Writer W[9] has update data=9
 Writer W[8] has update data=1

